<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Confirmación de Circular</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        background-color: #f8f9fa;
      }
      .card {
        border-radius: 15px;
        border: 1px solid #ccc;
      }
      .form-group input {
        border-radius: 10px;
        padding: 12px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      }
      .form-group label {
        font-weight: 600;
      }
      button {
        border-radius: 30px;
        padding: 12px;
        font-size: 16px;
        font-weight: 600;
      }
      h1 {
        font-weight: 700;
        font-size: 28px;
        margin-bottom: 20px;
      }
      .card-body {
        padding: 40px;
      }
      .card {
        background-color: #ffffff;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }
      .container {
        max-width: 500px;
      }
      .btn-primary {
        background-color: #007bff;
        border: none;
        transition: background-color 0.3s ease;
      }
      .btn-primary:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <div class="text-center mb-4">
        <img
          src="./mater-768x320.png"
          alt="Logo de la Escuela"
          style="width: 200px; height: auto"
        />
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h1 class="card-title text-center">Circular de matrícula</h1>
          <h1 class="card-title text-center">2026</h1>
          <p class="text-center">
            <b
              >(tenga en cuenta que al elegir el curso será para el año
              próximo)</b
            >
          </p>

          <!-- FORMULARIO -->
          <form id="confirmarForm">
            <div class="form-group">
              <label for="dni">DNI del Alumno:</label>
              <input
                type="number"
                id="dni"
                name="dni"
                class="form-control"
                placeholder="Ingresa el DNI del alumno"
                required
              />
            </div>

            <div class="form-group">
              <label for="nombre">Nombre del Alumno:</label>
              <input
                type="text"
                id="nombre"
                name="nombre"
                class="form-control"
                placeholder="Ingresa el nombre del alumno"
                required
              />
            </div>

            <div class="form-group">
              <label for="apellido">Apellido del Alumno:</label>
              <input
                type="text"
                id="apellido"
                name="apellido"
                class="form-control"
                placeholder="Ingresa el apellido del alumno"
                required
              />
            </div>

            <div class="form-group">
              <label for="nivel">Selecciona el nivel:</label>
              <select id="nivel" name="nivel" class="form-control" required>
                <option value="">Selecciona el nivel</option>
                <option value="inicial">Nivel Inicial</option>
                <option value="primario">Nivel Primario</option>
                <option value="secundario">Nivel Secundario</option>
              </select>
            </div>

            <div class="form-group">
              <label for="curso">Curso/Grado/Año a inscribirse 2026:</label>
              <select id="curso" name="curso" class="form-control" required>
                <option value="">Selecciona primero el nivel</option>
              </select>
            </div>

            <!-- ✅ NUEVO CAMPO EMAIL -->
            <div class="form-group">
              <label for="email">Correo electrónico del responsable:</label>
              <input
                type="email"
                id="email"
                name="email"
                class="form-control"
                placeholder="ejemplo@correo.com"
                required
              />
            </div>

            <button type="submit" class="btn btn-primary btn-block">
              Confirmar
            </button>
          </form>

          <div id="mensaje" class="mt-3"></div>
        </div>
      </div>
    </div>

    <script>
      // === Cursos según el nivel seleccionado ===
      const nivelSelect = document.getElementById("nivel");
      const cursoSelect = document.getElementById("curso");

      const nombresCursos = {
        1: "Sala de 3",
        2: "Sala de 4",
        3: "Sala de 5",
        4: "Primer grado",
        5: "Segundo grado",
        6: "Tercer grado",
        7: "Cuarto grado",
        8: "Quinto grado",
        9: "Sexto grado",
        10: "Primer año",
        11: "Segundo año",
        12: "Tercer año",
        13: "Cuarto año",
        14: "Quinto año",
        15: "Sexto año",
      };

      nivelSelect.addEventListener("change", function () {
        const nivel = nivelSelect.value;
        cursoSelect.innerHTML =
          '<option value="">Selecciona el curso</option>';

        let opciones = [];
        if (nivel === "inicial") {
          opciones = [
            { value: 1, text: "Sala de 3" },
            { value: 2, text: "Sala de 4" },
            { value: 3, text: "Sala de 5" },
          ];
        } else if (nivel === "primario") {
          opciones = [
            { value: 4, text: "Primer grado" },
            { value: 5, text: "Segundo grado" },
            { value: 6, text: "Tercer grado" },
            { value: 7, text: "Cuarto grado" },
            { value: 8, text: "Quinto grado" },
            { value: 9, text: "Sexto grado" },
          ];
        } else if (nivel === "secundario") {
          opciones = [
            { value: 10, text: "Primer año" },
            { value: 11, text: "Segundo año" },
            { value: 12, text: "Tercer año" },
            { value: 13, text: "Cuarto año" },
            { value: 14, text: "Quinto año" },
            { value: 15, text: "Sexto año" },
          ];
        }

        opciones.forEach((op) => {
          const opt = document.createElement("option");
          opt.value = op.value;
          opt.textContent = op.text;
          cursoSelect.appendChild(opt);
        });
      });

      // === Buscar alumno por DNI ===
      document.getElementById("dni").addEventListener("change", async function () {
        const dni = this.value;
        try {
          const response = await fetch(
            `https://circular-backend-k0ta.onrender.com/api/alumnos/dni/${dni}`
          );
          if (response.ok) {
            const alumno = await response.json();
            document.getElementById("nombre").value = alumno.nombre;
            document.getElementById("apellido").value = alumno.apellido;
          } else {
            Swal.fire({
              icon: "warning",
              title: "Alumno no encontrado",
              text: "No se encontró ningún alumno con ese DNI.",
            });
            document.getElementById("nombre").value = "";
            document.getElementById("apellido").value = "";
          }
        } catch (error) {
          console.error("Error al buscar el alumno:", error);
          Swal.fire({
            icon: "error",
            title: "Error al buscar el alumno",
            text: "Hubo un problema al intentar buscar el alumno. Por favor, intenta nuevamente.",
          });
        }
      });

      // === Confirmar inscripción ===
      document
        .getElementById("confirmarForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const dni = document.getElementById("dni").value;
          const nombre = document.getElementById("nombre").value;
          const apellido = document.getElementById("apellido").value;
          const curso = document.getElementById("curso").value;
          const email = document.getElementById("email").value;
          const nombreCurso = nombresCursos[curso];

          if (!dni || !nombre || !apellido || !curso || !email) {
            Swal.fire({
              icon: "warning",
              title: "Campos incompletos",
              text: "Por favor, completa todos los campos.",
            });
            return;
          }

          Swal.fire({
            title: "¿Confirmar los datos ingresados?",
            html: `
              <p><strong>DNI:</strong> ${dni}</p>
              <p><strong>Nombre:</strong> ${nombre}</p>
              <p><strong>Apellido:</strong> ${apellido}</p>
              <p><strong>Curso:</strong> ${nombreCurso}</p>
              <p><strong>Email:</strong> ${email}</p>
            `,
            icon: "info",
            showCancelButton: true,
            confirmButtonText: "Confirmar",
            cancelButtonText: "Cancelar",
          }).then(async (result) => {
            if (result.isConfirmed) {
              try {
                const response = await fetch(
                  "https://circular-backend-k0ta.onrender.com/api/confirmar",
                  {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ dni, nombre, apellido, curso, email }),
                  }
                );

                const result = await response.json();

                if (result.confirmado) {
                  Swal.fire({
                    icon: "info",
                    title: "Confirmación ya realizada",
                    text: result.message,
                  });
                } else {
                  Swal.fire({
                    icon: "success",
                    title: "Confirmación exitosa",
                    text: `Alumno en ${nombreCurso} ha sido confirmado.`,
                    timer: 4000,
                    showConfirmButton: true,
                  }).then(() => {
                    document.getElementById("confirmarForm").reset();
                  });
                }
              } catch (error) {
                Swal.fire({
                  icon: "error",
                  title: "Error en la confirmación",
                  text: "No se pudo confirmar la recepción. Por favor, intenta nuevamente.",
                });
              }
            }
          });
        });
    </script>
  </body>
</html>
